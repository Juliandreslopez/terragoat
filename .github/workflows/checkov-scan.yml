on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
name: PC - Code Scan

jobs:
  deploy:
    name: PC - Code Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    
    # - name: Prisma Cloud Code Security Scan
    #   id: checkov
    #   uses: bridgecrewio/checkov-action@master
    #   env:
    #     PRISMA_API_URL: ${{ secrets.PCCS_CONSOLE_URL }}
    #   with:
    #     api-key: ${{ secrets.PCC_USER }}::${{ secrets.PCC_PASS }}
    #     use_enforcement_rules: true

    - name: Run Checkov and format JSON summary
      id: checkov
      run: |
        pip install jq checkov
        checkov -d . --prisma-api-url ${{ secrets.PCCS_CONSOLE_URL }} --bc-api-key ${{ secrets.PCC_USER }}::${{ secrets.PCC_PASS }} --use-enforcement-rules --branch master --repo-id Juliandreslopez/terragoat --output json > checkov_report.json
        echo "## ðŸ›¡ï¸ Checkov Scan Summary" >> $GITHUB_STEP_SUMMARY
        jq -r '
          .summary | 
          "âœ… Passed: \(.passed)\nâŒ Failed: \(.failed)\nâš ï¸ Skipped: \(.skipped)\n\nDetails:\n" 
        ' checkov_report.json >> $GITHUB_STEP_SUMMARY
